---
version: 2.1

executors:
  cli:
    docker:
      - image: circleci/circleci-cli:latest
        auth:
          username: $DOCKER_HUB_USERNAME
          password: $DOCKER_HUB_PASSWORD

jobs:
  validate:
    executor: cli
    steps:
      - checkout
      - run: circleci config pack src | circleci orb validate -
  create-orb:
    executor: cli
    steps:
      - checkout
      - run: circleci orb create lovepop/terraform --private --token $CIRCLE_TOKEN
  publish-dev:
    executor: cli
    steps:
      - checkout
      - run: circleci config pack src | circleci orb publish - lovepop/terraform@dev:$CIRCLE_SHA1 --token $CIRCLE_TOKEN
  promote-prod:
    executor: cli
    steps:
      - checkout
      - run: circleci orb publish promote lovepop/terraform@dev:$CIRCLE_SHA1 patch --token $CIRCLE_TOKEN

workflows:
  all:
    jobs:
      - validate:
      - create-orb:
          requires:
            - validate
      - publish-dev:
          requires:
            - create-orb
      - promote-prod:
          requires:
            - publish-dev
          filters:
            branches:
              only: orb_terraform